TODO: Re-write slowest blocks in C for better performance.
